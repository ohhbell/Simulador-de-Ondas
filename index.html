<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Ondas Sonoras (AudioWorklet)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a0ca3;
      --secondary: #7209b7;
      --accent: #06d6a0;
      --text: #2b2d42;
      --light: #f8f9fa;
      --white: #ffffff;
      --wave1: #3a86ff;
      --wave2: #ff006e;
      --sum-wave: #06d6a0;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f5f7fa;
      color: var(--text);
      line-height: 1.6;
    }
    .wave-card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border: none;
    }
    .wave-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      background: transparent;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-weight: 600;
    }
    canvas {
      width: 100%;
      height: 180px;
      border-radius: 8px;
      background-color: var(--white);
    }
    .btn-primary {
      background-color: var(--primary);
      border: none;
      padding: 10px 20px;
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    .btn-success {
      background-color: var(--accent);
      border-color: var(--accent);
    }
    .btn-success:hover {
      background-color: #05a075;
      border-color: #05a075;
    }
    .btn-outline-primary {
      border-color: var(--primary);
      color: var(--primary);
    }
    .btn-outline-primary:hover {
      background-color: var(--primary);
      color: var(--white);
    }
    .form-range::-webkit-slider-thumb {
      background: var(--primary);
    }
    .control-label {
      font-weight: 500;
      color: var(--text);
    }
    .value-display {
      font-family: 'Fira Code', monospace;
      color: var(--primary-dark);
    }
    .preset-btn {
      transition: all 0.2s ease;
    }
    .preset-btn:hover {
      transform: translateY(-2px);
    }
    .inactive-wave {
      background-color: rgba(248, 249, 250, 0.7);
      color: #adb5bd;
    }
    .wave-card .inactive-wave .control-label,
    .wave-card .inactive-wave .form-select,
    .wave-card .inactive-wave .form-range,
    .wave-card .inactive-wave .value-display {
        color: #adb5bd !important;
    }
    .wave-card .inactive-wave .form-select {
        background-color: rgba(248, 249, 250, 0.9);
    }
    .wave-title-1 {
      color: var(--wave1);
    }
    .wave-title-2 {
      color: var(--wave2);
    }
    .wave-title-sum {
      color: var(--sum-wave);
    }
    .hero-section {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: 0 0 20px 20px;
    }
    @media (max-width: 768px) {
      .hero-section {
        border-radius: 0 0 12px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="hero-section py-4 mb-5 shadow-sm">
    <div class="container">
      <div class="row">
        <div class="col-12 text-center">
          <h1 class="display-6 fw-bold mb-2">Simulador de Ondas Sonoras</h1>
          <p class="lead mb-0">Explore a física do som de forma interativa</p>
        </div>
      </div>
    </div>
  </div>
  <div class="container mb-5">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="wave-card p-4 mb-4">
          <h5 class="card-header border-0 pb-3"><i class="fas fa-sliders-h me-2"></i>Controles</h5>
          <div class="d-flex flex-wrap gap-2 mb-4">
            <button id="toggleSoundBtn" class="btn btn-primary btn-sm">
              <i class="fas fa-power-off me-1"></i> Ligar Som
            </button>
            <button id="resetBtn" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-redo me-1"></i> Resetar
            </button>
          </div>
          <div class="mb-4">
            <h6 class="mb-3"><i class="fas fa-prescription-bottle me-2"></i>Presets</h6>
            <div class="d-flex flex-wrap gap-2">
              <button data-preset="default" class="preset-btn btn btn-sm btn-outline-secondary">
                Padrão
              </button>
              <button data-preset="constructive" class="preset-btn btn btn-sm btn-outline-secondary">
                Construtiva
              </button>
              <button data-preset="destructive" class="preset-btn btn btn-sm btn-outline-secondary">
                Destrutiva
              </button>
              <button data-preset="beats" class="preset-btn btn btn-sm btn-outline-secondary">
                Batimentos
              </button>
            </div>
          </div>
          <div class="wave-card p-4 mb-4">
            <h5 class="wave-title-1 card-header border-0 pb-2 d-flex justify-content-between align-items-center">
              <span><i class="fas fa-wave-square me-2"></i>Onda 1</span>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="wave1Active" checked>
              </div>
            </h5>
            <div id="wave1Controls">
              <div class="mb-3">
                <label for="wave1Type" class="form-label control-label">Tipo de Onda</label>
                <select class="form-select form-select-sm" id="wave1Type">
                  <option value="sine">Seno</option>
                  <option value="square">Quadrada</option>
                  <option value="triangle">Triangular</option>
                  <option value="sawtooth">Dente de Serra</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="wave1Freq" class="form-label control-label">Frequência: <span id="wave1FreqValue" class="value-display">440</span> Hz</label>
                <input type="range" class="form-range" id="wave1Freq" min="100" max="1000" value="440" step="1">
              </div>
              <div class="mb-3">
                <label for="wave1Amp" class="form-label control-label">Amplitude: <span id="wave1AmpValue" class="value-display">0.7</span></label>
                <input type="range" class="form-range" id="wave1Amp" min="0" max="1" value="0.7" step="0.01">
              </div>
              <div class="mb-0">
                <label for="wave1Phase" class="form-label control-label">Fase: <span id="wave1PhaseValue" class="value-display">0</span>°</label>
                <input type="range" class="form-range" id="wave1Phase" min="0" max="360" value="0" step="1">
              </div>
            </div>
          </div>
          <div class="wave-card p-4">
            <h5 class="wave-title-2 card-header border-0 pb-2 d-flex justify-content-between align-items-center">
              <span><i class="fas fa-wave-square me-2"></i>Onda 2</span>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="wave2Active" checked>
              </div>
            </h5>
            <div id="wave2Controls">
              <div class="mb-3">
                <label for="wave2Type" class="form-label control-label">Tipo de Onda</label>
                <select class="form-select form-select-sm" id="wave2Type">
                  <option value="sine">Seno</option>
                  <option value="square">Quadrada</option>
                  <option value="triangle">Triangular</option>
                  <option value="sawtooth">Dente de Serra</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="wave2Freq" class="form-label control-label">Frequência: <span id="wave2FreqValue" class="value-display">440</span> Hz</label>
                <input type="range" class="form-range" id="wave2Freq" min="100" max="1000" value="440" step="1">
              </div>
              <div class="mb-3">
                <label for="wave2Amp" class="form-label control-label">Amplitude: <span id="wave2AmpValue" class="value-display">0.7</span></label>
                <input type="range" class="form-range" id="wave2Amp" min="0" max="1" value="0.7" step="0.01">
              </div>
              <div class="mb-0">
                <label for="wave2Phase" class="form-label control-label">Fase: <span id="wave2PhaseValue" class="value-display">0</span>°</label>
                <input type="range" class="form-range" id="wave2Phase" min="0" max="360" value="0" step="1">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-7">
        <div class="wave-card p-4 mb-4">
          <h5 class="wave-title-1 card-header border-0 pb-3"><i class="fas fa-chart-line me-2"></i>Onda 1</h5>
          <canvas id="wave1Canvas" width="600" height="180"></canvas>
        </div>
        <div class="wave-card p-4 mb-4">
          <h5 class="wave-title-2 card-header border-0 pb-3"><i class="fas fa-chart-line me-2"></i>Onda 2</h5>
          <canvas id="wave2Canvas" width="600" height="180"></canvas>
        </div>
        <div class="wave-card p-4">
          <h5 class="wave-title-sum card-header border-0 pb-3"><i class="fas fa-plus-circle me-2"></i>Onda Resultante</h5>
          <canvas id="sumWaveCanvas" width="600" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const wave1Canvas = document.getElementById('wave1Canvas');
    const wave1Ctx = wave1Canvas.getContext('2d');
    const wave2Canvas = document.getElementById('wave2Canvas');
    const wave2Ctx = wave2Canvas.getContext('2d');
    const sumWaveCanvas = document.getElementById('sumWaveCanvas');
    const sumWaveCtx = sumWaveCanvas.getContext('2d');
    
    const toggleSoundBtn = document.getElementById('toggleSoundBtn');
    const resetBtn = document.getElementById('resetBtn');
    const presetButtons = document.querySelectorAll('.preset-btn');
    
    const wave1ActiveCheck = document.getElementById('wave1Active');
    const wave1TypeSelect = document.getElementById('wave1Type');
    const wave1FreqSlider = document.getElementById('wave1Freq');
    const wave1FreqValue = document.getElementById('wave1FreqValue');
    const wave1AmpSlider = document.getElementById('wave1Amp');
    const wave1AmpValue = document.getElementById('wave1AmpValue');
    const wave1PhaseSlider = document.getElementById('wave1Phase');
    const wave1PhaseValue = document.getElementById('wave1PhaseValue');
    const wave1Controls = document.getElementById('wave1Controls');
    
    const wave2ActiveCheck = document.getElementById('wave2Active');
    const wave2TypeSelect = document.getElementById('wave2Type');
    const wave2FreqSlider = document.getElementById('wave2Freq');
    const wave2FreqValue = document.getElementById('wave2FreqValue');
    const wave2AmpSlider = document.getElementById('wave2Amp');
    const wave2AmpValue = document.getElementById('wave2AmpValue');
    const wave2PhaseSlider = document.getElementById('wave2Phase');
    const wave2PhaseValue = document.getElementById('wave2PhaseValue');
    const wave2Controls = document.getElementById('wave2Controls');

    let soundOn = false;
    let audioCtx = null;
    let audioWorkletNode = null;
    let animationOffset = 0;
    const animationSpeed = 0.05;

    function init() {
      setupEventListeners();
      setupCanvas();
      loadPreset('default');
      updateWaveDisplays();
      requestAnimationFrame(draw);
    }

    function setupCanvas() {
      const canvases = [wave1Canvas, wave2Canvas, sumWaveCanvas];
      const dpr = window.devicePixelRatio || 1;
      
      canvases.forEach(canvas => {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = `${rect.width}px`;
        canvas.style.height = `${rect.height}px`;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
      });
    }

    function setupEventListeners() {
      toggleSoundBtn.addEventListener('click', toggleSound);
      resetBtn.addEventListener('click', resetControls);
      presetButtons.forEach(btn => {
        btn.addEventListener('click', () => loadPreset(btn.dataset.preset));
      });

      const allControls = [
        wave1ActiveCheck, wave1TypeSelect, wave1FreqSlider, wave1AmpSlider, wave1PhaseSlider,
        wave2ActiveCheck, wave2TypeSelect, wave2FreqSlider, wave2AmpSlider, wave2PhaseSlider
      ];
      
      allControls.forEach(control => {
        control.addEventListener('input', updateAudioAndDisplay);
        control.addEventListener('change', updateAudioAndDisplay);
      });

      window.addEventListener('resize', () => {
        setupCanvas();
      });
    }

    function updateAudioAndDisplay() {
      wave1FreqValue.textContent = wave1FreqSlider.value;
      wave1AmpValue.textContent = parseFloat(wave1AmpSlider.value).toFixed(2);
      wave1PhaseValue.textContent = wave1PhaseSlider.value;
      
      wave2FreqValue.textContent = wave2FreqSlider.value;
      wave2AmpValue.textContent = parseFloat(wave2AmpSlider.value).toFixed(2);
      wave2PhaseValue.textContent = wave2PhaseSlider.value;

      updateAudioParams();
      updateWaveDisplays();
    }

    function resetControls() {
      loadPreset('default');
    }

    function loadPreset(presetName) {
      switch(presetName) {
        case 'default':
          wave1ActiveCheck.checked = true;
          wave1TypeSelect.value = 'sine';
          wave1FreqSlider.value = 440;
          wave1AmpSlider.value = 0.7;
          wave1PhaseSlider.value = 0;
          
          wave2ActiveCheck.checked = true;
          wave2TypeSelect.value = 'sine';
          wave2FreqSlider.value = 440;
          wave2AmpSlider.value = 0.7;
          wave2PhaseSlider.value = 0;
          break;
        case 'constructive':
          wave1ActiveCheck.checked = true;
          wave1TypeSelect.value = 'sine';
          wave1FreqSlider.value = 300;
          wave1AmpSlider.value = 0.5;
          wave1PhaseSlider.value = 0;
          
          wave2ActiveCheck.checked = true;
          wave2TypeSelect.value = 'sine';
          wave2FreqSlider.value = 300;
          wave2AmpSlider.value = 0.5;
          wave2PhaseSlider.value = 0;
          break;
        case 'destructive':
          wave1ActiveCheck.checked = true;
          wave1TypeSelect.value = 'sine';
          wave1FreqSlider.value = 500;
          wave1AmpSlider.value = 0.5;
          wave1PhaseSlider.value = 0;
          
          wave2ActiveCheck.checked = true;
          wave2TypeSelect.value = 'sine';
          wave2FreqSlider.value = 500;
          wave2AmpSlider.value = 0.5;
          wave2PhaseSlider.value = 180;
          break;
        case 'beats':
          wave1ActiveCheck.checked = true;
          wave1TypeSelect.value = 'sine';
          wave1FreqSlider.value = 440;
          wave1AmpSlider.value = 0.6;
          wave1PhaseSlider.value = 0;
          
          wave2ActiveCheck.checked = true;
          wave2TypeSelect.value = 'sine';
          wave2FreqSlider.value = 443;
          wave2AmpSlider.value = 0.6;
          wave2PhaseSlider.value = 0;
          break;
      }
      animationOffset = 0;
      updateAudioAndDisplay();
    }

    async function toggleSound() {
      if (soundOn) {
        stopSound();
        toggleSoundBtn.innerHTML = '<i class="fas fa-power-off me-1"></i> Ligar Som';
        toggleSoundBtn.classList.remove('btn-success');
        toggleSoundBtn.classList.add('btn-primary');
        soundOn = false;
      } else {
        try {
          await startSound();
          toggleSoundBtn.innerHTML = '<i class="fas fa-volume-up me-1"></i> Desligar Som';
          toggleSoundBtn.classList.remove('btn-primary');
          toggleSoundBtn.classList.add('btn-success');
          soundOn = true;
        } catch (e) {
          console.error("Erro ao iniciar o áudio:", e);
          alert("Não foi possível iniciar o áudio. Verifique se o arquivo 'phase-processor.js' está no mesmo diretório.");
        }
      }
    }

    async function startSound() {
      if (audioCtx) return; 
      
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      
      // Adiciona o módulo do AudioWorklet. É aqui que o arquivo 'phase-processor.js' é carregado.
      await audioCtx.audioWorklet.addModule('phase-processor.js');

      // Cria a instância do AudioWorkletNode
      audioWorkletNode = new AudioWorkletNode(audioCtx, 'phase-processor');
      audioWorkletNode.connect(audioCtx.destination);
      
      updateAudioParams();
    }

    function stopSound() {
      if (!audioCtx) return;
      
      audioWorkletNode.disconnect(audioCtx.destination);
      audioWorkletNode = null;
      audioCtx.close().then(() => { 
          audioCtx = null;
      });
    }

    function updateAudioParams() {
      if (!audioWorkletNode) return;
      
      const wave1Params = {
        active: wave1ActiveCheck.checked,
        type: wave1TypeSelect.value,
        freq: parseFloat(wave1FreqSlider.value),
        amp: parseFloat(wave1AmpSlider.value),
        phase: parseFloat(wave1PhaseSlider.value) * Math.PI / 180,
      };

      const wave2Params = {
        active: wave2ActiveCheck.checked,
        type: wave2TypeSelect.value,
        freq: parseFloat(wave2FreqSlider.value),
        amp: parseFloat(wave2AmpSlider.value),
        phase: parseFloat(wave2PhaseSlider.value) * Math.PI / 180,
      };

      // Envia os parâmetros para o AudioWorklet via postMessage
      audioWorkletNode.port.postMessage({
        wave1: wave1Params,
        wave2: wave2Params
      });
    }
    
    function getSample(type, phase) {
      switch (type) {
        case 'sine':
          return Math.sin(phase);
        case 'square':
          return Math.sin(phase) > 0 ? 1 : -1;
        case 'triangle':
          return (2 / Math.PI) * Math.asin(Math.sin(phase));
        case 'sawtooth':
          return 2 * ((phase / (2 * Math.PI)) % 1) - 1;
        default:
          return 0;
      }
    }

    function draw() {
      if (soundOn) { 
          animationOffset += animationSpeed; 
          if (animationOffset > 2 * Math.PI) {
              animationOffset -= 2 * Math.PI;
          }
      }

      drawWaveforms();
      requestAnimationFrame(draw);
    }

    function drawWaveforms() {
      const width = wave1Canvas.width / (window.devicePixelRatio || 1);
      const height = wave1Canvas.height / (window.devicePixelRatio || 1);
      const samples = 600;
      const wave1Active = wave1ActiveCheck.checked;
      const wave2Active = wave2ActiveCheck.checked;
      
      wave1Ctx.clearRect(0, 0, width, height);
      wave2Ctx.clearRect(0, 0, width, height);
      sumWaveCtx.clearRect(0, 0, width, height);
      
      const wave1 = [];
      const wave2 = [];
      const sumWave = [];
      
      for (let i = 0; i < samples; i++) {
        const x = (i / samples) * 2 * Math.PI;
        
        let val1 = 0;
        if (wave1Active) {
          const amp1 = parseFloat(wave1AmpSlider.value);
          const type1 = wave1TypeSelect.value;
          const phase1 = parseFloat(wave1PhaseSlider.value) * Math.PI / 180;
          const x1 = x * parseFloat(wave1FreqSlider.value) / 100 + phase1 + (soundOn ? animationOffset : 0); 
          val1 = getSample(type1, x1) * amp1;
        }
        wave1.push(val1);
        
        let val2 = 0;
        if (wave2Active) {
          const amp2 = parseFloat(wave2AmpSlider.value);
          const type2 = wave2TypeSelect.value;
          const phase2 = parseFloat(wave2PhaseSlider.value) * Math.PI / 180;
          const x2 = x * parseFloat(wave2FreqSlider.value) / 100 + phase2 + (soundOn ? animationOffset : 0); 
          val2 = getSample(type2, x2) * amp2;
        }
        wave2.push(val2);
        
        let sumVal = val1 + val2;
        sumWave.push(sumVal);
      }
      
      if (wave1Active) {
        drawSingleWave(wave1Ctx, wave1, width, height, samples, 'var(--wave1)');
      } else {
        clearAndDisplayMessage(wave1Ctx, width, height, 'Onda 1 desativada');
      }
      
      if (wave2Active) {
        drawSingleWave(wave2Ctx, wave2, width, height, samples, 'var(--wave2)');
      } else {
        clearAndDisplayMessage(wave2Ctx, width, height, 'Onda 2 desativada');
      }
      
      drawSingleWave(sumWaveCtx, sumWave, width, height, samples, 'var(--sum-wave)');
    }

    function drawSingleWave(ctx, waveData, width, height, samples, color) {
      const sliceWidth = width / samples;
      
      ctx.strokeStyle = '#eee';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, height/2);
      ctx.lineTo(width, height/2);
      ctx.stroke();
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < samples; i++) {
        const y = height/2 - waveData[i] * (height/3); 
        if (i === 0) ctx.moveTo(i * sliceWidth, y);
        else ctx.lineTo(i * sliceWidth, y);
      }
      ctx.stroke();
    }

    function clearAndDisplayMessage(ctx, width, height, message) {
      ctx.fillStyle = '#f8f9fa';
      ctx.fillRect(0, 0, width, height);
      ctx.fillStyle = '#adb5bd';
      ctx.font = '14px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle'; 
      ctx.fillText(message, width/2, height/2);
    }

    function updateWaveDisplays() {
      const wave1Active = wave1ActiveCheck.checked;
      const wave2Active = wave2ActiveCheck.checked;
      
      wave1TypeSelect.disabled = !wave1Active;
      wave1FreqSlider.disabled = !wave1Active;
      wave1AmpSlider.disabled = !wave1Active;
      wave1PhaseSlider.disabled = !wave1Active;
      
      wave2TypeSelect.disabled = !wave2Active;
      wave2FreqSlider.disabled = !wave2Active;
      wave2AmpSlider.disabled = !wave2Active;
      wave2PhaseSlider.disabled = !wave2Active;
      
      if (wave1Active) {
        wave1Controls.classList.remove('inactive-wave');
      } else {
        wave1Controls.classList.add('inactive-wave');
      }
      
      if (wave2Active) {
        wave2Controls.classList.remove('inactive-wave');
      } else {
        wave2Controls.classList.add('inactive-wave');
      }
    }

    init();
  </script>
</body>
</html>